# Python ç‰ˆæœ¬ä½¿ç”¨æŒ‡å—

## ğŸ¯ æ¥å£è®¾è®¡

ä¸ Cloudflare Worker ç‰ˆæœ¬ä¿æŒä¸€è‡´ï¼Œå®Œå…¨åˆ†ç¦»åˆå§‹åŒ–å’Œå¢é‡æ›´æ–°é€»è¾‘ã€‚

| æ–¹æ³• | ç”¨é€” | ç‰¹ç‚¹ | é€‚ç”¨åœºæ™¯ |
|------|------|------|----------|
| `fetch_batch_init()` | æ‰¹é‡åˆå§‹åŒ– | å›ºå®šæ‰¹æ¬¡ï¼Œè‡ªåŠ¨å»é‡ | é¦–æ¬¡åˆå§‹åŒ– |
| `fetch_incremental()` | å¢é‡æ›´æ–° | æ™ºèƒ½æ£€æµ‹ï¼Œè¡¥å…¨ç¼ºå¤± | æ—¥å¸¸æ›´æ–° |
| `fetch_latest()` | è·å–æœ€æ–° | è‡ªåŠ¨åˆ‡æ¢æ•°æ®æº | å¿«é€ŸæŸ¥è¯¢ |

## ğŸ“ ä½¿ç”¨æ–¹å¼

### 1. æ‰¹é‡åˆå§‹åŒ–ï¼ˆé¦–æ¬¡è¿è¡Œï¼‰

```python
from lotteries.ssq.spider import SSQSpider
from lotteries.ssq.database import SSQDatabase

spider = SSQSpider()
db = SSQDatabase()

# æ‰¹é‡åˆå§‹åŒ–ï¼šæ¯æ¬¡çˆ¬å– 100 æœŸ
batch_size = 100
total_count = 0

while True:
    # çˆ¬å–ä¸€æ‰¹æ•°æ®
    data = spider.fetch_batch_init(batch_size=batch_size)
    
    if not data:
        print("æœªè·å–åˆ°æ•°æ®")
        break
    
    # ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆè‡ªåŠ¨å»é‡ï¼‰
    inserted = 0
    skipped = 0
    
    for item in data:
        try:
            db.insert(item)
            inserted += 1
        except Exception as e:
            # å¦‚æœæ˜¯é‡å¤æ•°æ®ï¼Œè·³è¿‡
            if "Duplicate" in str(e) or "UNIQUE" in str(e):
                skipped += 1
            else:
                print(f"æ’å…¥å¤±è´¥: {e}")
    
    total_count += inserted
    print(f"æœ¬æ‰¹æ¬¡: æ–°å¢ {inserted} æ¡ï¼Œè·³è¿‡ {skipped} æ¡")
    print(f"å½“å‰æ€»è®¡: {total_count} æ¡")
    
    # å¦‚æœå¤§éƒ¨åˆ†æ•°æ®å·²å­˜åœ¨ï¼Œè¯´æ˜å¯èƒ½å·²ç»çˆ¬å–å®Œæˆ
    if skipped > batch_size * 0.9:
        print("å¤§éƒ¨åˆ†æ•°æ®å·²å­˜åœ¨ï¼Œåˆå§‹åŒ–å®Œæˆ")
        break
    
    # ç»§ç»­ä¸‹ä¸€æ‰¹
    import time
    time.sleep(2)  # é˜²æ­¢è¯·æ±‚è¿‡å¿«
```

### 2. å¢é‡æ›´æ–°ï¼ˆæ—¥å¸¸è¿è¡Œï¼‰

```python
from lotteries.ssq.spider import SSQSpider
from lotteries.ssq.database import SSQDatabase

spider = SSQSpider()
db = SSQDatabase()

# è·å–æ•°æ®åº“ä¸­æœ€æ–°çš„æœŸå·
latest = db.get_latest()
if not latest:
    print("æ•°æ®åº“ä¸ºç©ºï¼Œè¯·å…ˆåˆå§‹åŒ–")
    exit(1)

db_latest_no = latest['lottery_no']
print(f"æ•°æ®åº“æœ€æ–°æœŸå·: {db_latest_no}")

# å¢é‡æ›´æ–°
new_data = spider.fetch_incremental(db_latest_no)

if not new_data:
    print("æ•°æ®å·²æ˜¯æœ€æ–°")
else:
    print(f"è·å–åˆ° {len(new_data)} æ¡æ–°æ•°æ®")
    
    # ä¿å­˜åˆ°æ•°æ®åº“
    for item in new_data:
        db.insert(item)
    
    print(f"å¢é‡æ›´æ–°å®Œæˆï¼Œæœ€æ–°æœŸå·: {new_data[-1]['lottery_no']}")
```

### 3. è·å–æœ€æ–°æ•°æ®

```python
from lotteries.ssq.spider import SSQSpider

spider = SSQSpider()

# è·å–æœ€æ–° 1 æœŸ
latest = spider.fetch_latest(count=1)
print(f"æœ€æ–°æœŸå·: {latest[0]['lottery_no']}")
print(f"çº¢çƒ: {latest[0]['red_balls']}")
print(f"è“çƒ: {latest[0]['blue_ball']}")

# è·å–æœ€æ–° 10 æœŸ
recent = spider.fetch_latest(count=10)
print(f"è·å–åˆ° {len(recent)} æœŸæ•°æ®")
```

## ğŸ”„ å®Œæ•´çš„åˆå§‹åŒ–è„šæœ¬

åˆ›å»º `scripts/init_ssq.py`ï¼š

```python
#!/usr/bin/env python3
"""
åŒè‰²çƒæ•°æ®åˆå§‹åŒ–è„šæœ¬
"""

import sys
import time
from lotteries.ssq.spider import SSQSpider
from lotteries.ssq.database import SSQDatabase

def main():
    spider = SSQSpider()
    db = SSQDatabase()
    
    print("ğŸš€ å¼€å§‹åˆå§‹åŒ–åŒè‰²çƒæ•°æ®...")
    print("="*50)
    
    batch_size = 100
    total_inserted = 0
    iteration = 0
    max_iterations = 50  # æœ€å¤šæ‰§è¡Œ 50 æ¬¡
    
    while iteration < max_iterations:
        iteration += 1
        print(f"\nğŸ“Š æ‰§è¡Œç¬¬ {iteration} æ¬¡...")
        
        try:
            # çˆ¬å–æ•°æ®
            data = spider.fetch_batch_init(batch_size=batch_size)
            
            if not data:
                print("âŒ æœªè·å–åˆ°æ•°æ®")
                break
            
            # ä¿å­˜æ•°æ®
            inserted = 0
            skipped = 0
            
            for item in data:
                try:
                    db.insert(item)
                    inserted += 1
                except Exception as e:
                    if "Duplicate" in str(e) or "UNIQUE" in str(e):
                        skipped += 1
                    else:
                        print(f"âš ï¸  æ’å…¥å¤±è´¥: {e}")
            
            total_inserted += inserted
            current_total = db.get_count()
            
            print(f"âœ… æœ¬æ‰¹æ¬¡å®Œæˆ")
            print(f"   æ–°å¢: {inserted} æ¡")
            print(f"   è·³è¿‡: {skipped} æ¡")
            print(f"   å½“å‰æ€»è®¡: {current_total} æ¡")
            
            # å¦‚æœå¤§éƒ¨åˆ†æ•°æ®å·²å­˜åœ¨ï¼Œè¯´æ˜å¯èƒ½å·²ç»å®Œæˆ
            if skipped > batch_size * 0.9:
                print("\nâš ï¸  å¤§éƒ¨åˆ†æ•°æ®å·²å­˜åœ¨ï¼Œåˆå§‹åŒ–å¯èƒ½å·²å®Œæˆ")
                print(f"å½“å‰æ•°æ®é‡: {current_total} æ¡")
                
                if current_total >= 1000:
                    print("âœ… æ•°æ®é‡å……è¶³ï¼Œåˆå§‹åŒ–å®Œæˆ")
                    break
                else:
                    print("ğŸ’¡ æ•°æ®é‡ä¸è¶³ 1000 æ¡ï¼Œå»ºè®®ç»§ç»­è¿è¡Œ")
            
            # ç­‰å¾…
            if iteration < max_iterations:
                print(f"\nâ³ ç­‰å¾… 2 ç§’åç»§ç»­...")
                time.sleep(2)
                
        except Exception as e:
            print(f"âŒ æ‰§è¡Œå¤±è´¥: {e}")
            break
    
    print("\n" + "="*50)
    print(f"ğŸ“Š åˆå§‹åŒ–å®Œæˆ")
    print(f"æ€»è®¡æ–°å¢: {total_inserted} æ¡")
    print(f"æ•°æ®åº“æ€»é‡: {db.get_count()} æ¡")
    print("="*50)

if __name__ == '__main__':
    main()
```

## ğŸ”„ å®Œæ•´çš„å¢é‡æ›´æ–°è„šæœ¬

åˆ›å»º `scripts/update_ssq.py`ï¼š

```python
#!/usr/bin/env python3
"""
åŒè‰²çƒæ•°æ®å¢é‡æ›´æ–°è„šæœ¬
"""

import sys
from lotteries.ssq.spider import SSQSpider
from lotteries.ssq.database import SSQDatabase

def main():
    spider = SSQSpider()
    db = SSQDatabase()
    
    print("ğŸ”„ å¼€å§‹å¢é‡æ›´æ–°...")
    print("="*50)
    
    # è·å–æ•°æ®åº“æœ€æ–°æœŸå·
    latest = db.get_latest()
    if not latest:
        print("âŒ æ•°æ®åº“ä¸ºç©ºï¼Œè¯·å…ˆè¿è¡Œåˆå§‹åŒ–è„šæœ¬")
        sys.exit(1)
    
    db_latest_no = latest['lottery_no']
    print(f"æ•°æ®åº“æœ€æ–°æœŸå·: {db_latest_no}")
    
    try:
        # å¢é‡æ›´æ–°
        new_data = spider.fetch_incremental(db_latest_no)
        
        if not new_data:
            print("âœ… æ•°æ®å·²æ˜¯æœ€æ–°ï¼Œæ— éœ€æ›´æ–°")
            sys.exit(0)
        
        print(f"ğŸ“Š è·å–åˆ° {len(new_data)} æ¡æ–°æ•°æ®")
        
        # ä¿å­˜æ•°æ®
        inserted = 0
        for item in new_data:
            try:
                db.insert(item)
                inserted += 1
            except Exception as e:
                print(f"âš ï¸  æ’å…¥å¤±è´¥: {e}")
        
        print(f"\nâœ… å¢é‡æ›´æ–°å®Œæˆ")
        print(f"   æ–°å¢: {inserted} æ¡")
        print(f"   æœ€æ–°æœŸå·: {new_data[-1]['lottery_no']}")
        print(f"   æ•°æ®åº“æ€»é‡: {db.get_count()} æ¡")
        
    except Exception as e:
        print(f"âŒ æ›´æ–°å¤±è´¥: {e}")
        sys.exit(1)
    
    print("="*50)

if __name__ == '__main__':
    main()
```

## ğŸ“Š å¯¹æ¯”

| ç‰¹æ€§ | `fetch_batch_init()` | `fetch_incremental()` |
|------|---------------------|----------------------|
| ç”¨é€” | æ‰¹é‡åˆå§‹åŒ– | å¢é‡æ›´æ–° |
| æ‰¹æ¬¡ | å›ºå®šï¼ˆ100æœŸï¼‰ | åŠ¨æ€ï¼ˆç¼ºå¤±çš„æ•°é‡ï¼‰ |
| èµ·ç‚¹ | API æœ€æ–° | æ•°æ®åº“æœ€æ–° + 1 |
| ç»ˆç‚¹ | å›ºå®šæ•°é‡ | çº¿ä¸Šæœ€æ–° |
| å»é‡ | æ•°æ®åº“å¤„ç† | è‡ªåŠ¨æ£€æŸ¥ |
| é‡å¤æ‰§è¡Œ | âœ… æ”¯æŒ | âœ… æ”¯æŒ |

## ğŸ¯ æœ€ä½³å®è·µ

### é¦–æ¬¡åˆå§‹åŒ–

```bash
# è¿è¡Œåˆå§‹åŒ–è„šæœ¬
python scripts/init_ssq.py

# æˆ–è€…æ‰‹åŠ¨æ§åˆ¶
python -c "
from lotteries.ssq.spider import SSQSpider
spider = SSQSpider()
data = spider.fetch_batch_init(batch_size=100)
print(f'è·å– {len(data)} æ¡æ•°æ®')
# ç„¶åä¿å­˜åˆ°æ•°æ®åº“
"
```

### æ—¥å¸¸æ›´æ–°

```bash
# è¿è¡Œæ›´æ–°è„šæœ¬
python scripts/update_ssq.py

# æˆ–è€…é…ç½® crontab
0 22 * * * cd /path/to/project && python scripts/update_ssq.py
```

### æµ‹è¯•

```bash
# æµ‹è¯•æ‰€æœ‰åŠŸèƒ½
python lotteries/ssq/test_spider.py
```

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **åˆå§‹åŒ–å’Œæ›´æ–°åˆ†ç¦»**ï¼š
   - åˆå§‹åŒ–ç”¨ `fetch_batch_init()`
   - æ›´æ–°ç”¨ `fetch_incremental()`
   - ä¸è¦æ··ç”¨

2. **æ•°æ®å»é‡**ï¼š
   - æ•°æ®åº“è®¾ç½® UNIQUE çº¦æŸ
   - é‡å¤æ•°æ®è‡ªåŠ¨è·³è¿‡
   - å¯ä»¥å®‰å…¨åœ°é‡å¤æ‰§è¡Œ

3. **æ‰¹æ¬¡å¤§å°**ï¼š
   - å»ºè®® 100 æœŸ/æ‰¹
   - å¤ªå¤§å¯èƒ½è¶…æ—¶
   - å¤ªå°æ•ˆç‡ä½

4. **é”™è¯¯å¤„ç†**ï¼š
   - æ•è·å¼‚å¸¸
   - è®°å½•æ—¥å¿—
   - å¯ä»¥é‡è¯•

---

**æœ€åæ›´æ–°**ï¼š2025-11-17  
**ç‰ˆæœ¬**ï¼š2.0.0
