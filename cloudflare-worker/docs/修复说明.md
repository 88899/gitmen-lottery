# 数据爬取问题修复说明

## 问题

你在本地执行 `init.sh` 时遇到重复失败的情况。

## 原因

Cloudflare Worker 版本只使用了中彩网（zhcw.com）一个数据源，当这个源在某些环境下被限制时，就会失败。而 Python 版本有 500.com 作为备用源，所以可以成功。

## 修复

我已经为 Cloudflare Worker 版本添加了**双数据源支持**：

1. **主数据源**：中彩网 API (`jc.zhcw.com`)
2. **备用数据源**：500彩票网 (`datachart.500.com`)

系统会自动切换：
- 先尝试主数据源
- 如果失败，自动切换到备用数据源
- 两个都失败才报错

## 测试结果

```bash
✅ 主数据源（中彩网）正常
✅ 备用数据源（500.com）正常
✅ 自动切换机制正常
✅ 历史数据获取正常
```

## 如何使用

### 方式 1：本地测试

```bash
# 测试数据源是否正常
node cloudflare-worker/test-spider.js

# 如果测试通过，重新运行初始化
./cloudflare-worker/init.sh
```

### 方式 2：重新部署到 Cloudflare

```bash
cd cloudflare-worker
npx wrangler deploy
```

然后手动触发任务：
```bash
curl -X POST https://your-worker.workers.dev/run \
  -H "Authorization: Bearer YOUR_API_KEY"
```

## 注意事项

1. **500.com 限制**：备用数据源只能获取最近30期，如需完整历史数据请使用主数据源
2. **首次初始化**：建议多次触发 `/run` 直到数据完整
3. **网络问题**：如果两个数据源都失败，可能是网络限制，建议使用 Python 版本在本地爬取

## 相关文件

- `cloudflare-worker/src/spiders/ssq.js` - 爬虫代码（已修复）
- `cloudflare-worker/test-spider.js` - 测试脚本（新增）
- `cloudflare-worker/DATA_SOURCE_FIX.md` - 详细技术说明
- `cloudflare-worker/BUGFIX_SUMMARY.md` - 完整修复总结

## 需要帮助？

如果还有问题，请查看：
1. Cloudflare Worker 日志（Dashboard > Workers > Logs）
2. 运行测试脚本查看具体错误
3. 或者使用 Python 版本作为备选方案

---

修复完成！现在系统更加稳定可靠了 🎉
