# 接口设计说明

## 设计理念

**完全分离初始化和增量更新逻辑**，避免互相干扰。

## 接口对比

| 接口 | 用途 | 模式 | 适用场景 |
|------|------|------|----------|
| `/init` | 批量导入历史数据 | 全量爬取 | 首次初始化 |
| `/run` | 增量更新 | 智能增量 | 日常定时任务 |

## `/init` 接口（全量爬取）

### 设计原则

1. **固定批次**：每次爬取 100 期
2. **自动去重**：存在的跳过，不存在的写入
3. **可重复执行**：多次调用会继续爬取更多数据
4. **无状态判断**：不关心数据库中有多少数据

### 工作流程

```
调用 /init
  ↓
爬取 100 期数据
  ↓
逐条检查数据库
  ↓
存在 → 跳过
不存在 → 写入
  ↓
返回结果：
{
  "inserted": 95,  // 新增
  "skipped": 5,    // 跳过
  "total": 200     // 当前总数
}
```

### 使用方式

```bash
# 手动触发一次
curl -X POST "https://your-worker.workers.dev/init" \
  -H "Authorization: Bearer YOUR_API_KEY"

# 使用脚本自动化
bash cloudflare-worker/init.sh
```

### 何时停止

观察返回结果：

**继续执行**：
```json
{
  "inserted": 95,
  "skipped": 5
}
```
说明还有新数据，继续执行。

**可以停止**：
```json
{
  "inserted": 5,
  "skipped": 95
}
```
说明大部分数据已存在，可能已经爬取完成。

或者检查总数：
```bash
curl -s "https://your-worker.workers.dev/stats" | jq '.total_count'
```
- 如果 >= 1000，基本完整
- 如果 >= 4000，完全完整

## `/run` 接口（增量更新）

### 设计原则

1. **智能检测**：检查数据库中最新期号
2. **按需爬取**：只爬取缺失的新数据
3. **自动停止**：没有新数据时返回"数据已是最新"
4. **适合定时**：适合每天自动执行

### 工作流程

```
调用 /run
  ↓
查询数据库最新期号
  ↓
爬取线上最新期号
  ↓
比较
  ↓
相同 → 返回"数据已是最新"
不同 → 爬取缺失的数据
  ↓
返回结果：
{
  "new_count": 3,
  "latest_lottery_no": "2025135"
}
```

### 使用方式

```bash
# 手动触发
curl -X POST "https://your-worker.workers.dev/run" \
  -H "Authorization: Bearer YOUR_API_KEY"

# 配置定时任务（Cloudflare Dashboard）
# Cron: 0 14 * * *  (每天 22:00 北京时间)
```

### 返回示例

**有新数据**：
```json
{
  "success": true,
  "message": "增量更新完成",
  "mode": "incremental",
  "new_count": 3,
  "latest_lottery_no": "2025135"
}
```

**无新数据**：
```json
{
  "success": true,
  "message": "数据已是最新",
  "mode": "incremental",
  "lottery_no": "2025132"
}
```

## 使用场景

### 场景 1：首次初始化

```bash
# 1. 清空数据库（可选）
# 在 Cloudflare Dashboard 的 D1 Console 中执行：
# DELETE FROM ssq_lottery;

# 2. 运行初始化脚本
bash cloudflare-worker/init.sh

# 脚本会自动：
# - 调用 /init 接口
# - 每次爬取 100 期
# - 显示进度
# - 继续执行直到数据完整
```

### 场景 2：日常更新

```bash
# 方式 1：手动触发
curl -X POST "https://your-worker.workers.dev/run" \
  -H "Authorization: Bearer YOUR_API_KEY"

# 方式 2：配置定时任务
# 在 Cloudflare Dashboard 中配置 Cron Trigger
# 每天自动执行
```

### 场景 3：补充历史数据

如果发现数据不完整：

```bash
# 继续运行初始化脚本
bash cloudflare-worker/init.sh

# 会自动补充缺失的数据
```

## 优势

### 1. 逻辑清晰

- `/init`：专注于批量导入
- `/run`：专注于增量更新
- 互不干扰

### 2. 灵活性高

- 可以随时调用 `/init` 补充数据
- 可以随时调用 `/run` 检查更新
- 不会因为数据量而改变行为

### 3. 容错性好

- 数据库自动去重（UNIQUE 约束）
- 可以重复执行
- 不会重复插入数据

### 4. 易于理解

- 初始化就用 `/init`
- 日常更新就用 `/run`
- 简单明了

## 对比旧设计

### 旧设计的问题

```javascript
// ❌ 旧设计：根据数据量判断模式
if (dataCount === 0) {
  // 初始化模式
} else if (dataCount < 1000) {
  // 继续初始化
} else {
  // 增量模式
}
```

问题：
- 逻辑复杂
- 容易出错
- 难以理解

### 新设计的优势

```javascript
// ✅ 新设计：接口分离
// /init：总是全量爬取
// /run：总是增量更新
```

优势：
- 逻辑简单
- 职责清晰
- 易于维护

## 总结

| 特性 | `/init` | `/run` |
|------|---------|--------|
| 用途 | 批量导入 | 增量更新 |
| 模式 | 固定批次 | 智能检测 |
| 去重 | 自动跳过 | 自动跳过 |
| 停止条件 | 手动停止 | 自动停止 |
| 适用场景 | 首次初始化 | 日常定时 |
| 调用方式 | 手动/脚本 | 定时任务 |

---

**设计完成时间**：2025-11-17  
**设计理念**：职责分离，简单清晰
