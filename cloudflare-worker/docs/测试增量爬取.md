# 测试增量爬取逻辑

## 自动化测试（推荐）

```bash
cd cloudflare-worker
./scripts/test-incremental.sh
```

## 手动测试步骤

### 场景1：数据已是最新（正常情况）

**预期结果**：返回"数据已是最新"或"数据已存在"

```bash
# 1. 查看数据库最新记录
curl "${WORKER_URL}/latest"

# 2. 执行增量爬取
curl -X POST \
  -H "Authorization: Bearer ${API_KEY}" \
  "${WORKER_URL}/run"

# 预期响应：
# {
#   "success": true,
#   "message": "数据已是最新",
#   "mode": "incremental",
#   "lottery_no": "2025XXX",
#   "draw_date": "2025-XX-XX"
# }
```

### 场景2：有新数据（新一期开奖后）

**预期结果**：成功入库新数据

```bash
# 1. 查看数据库最新记录
curl "${WORKER_URL}/latest"
# 假设返回: 2025132

# 2. 等待新一期开奖（如 2025133）

# 3. 执行增量爬取
curl -X POST \
  -H "Authorization: Bearer ${API_KEY}" \
  "${WORKER_URL}/run"

# 预期响应：
# {
#   "success": true,
#   "message": "增量更新完成",
#   "mode": "incremental",
#   "new_count": 1,
#   "lottery_no": "2025133",
#   "draw_date": "2025-XX-XX"
# }

# 4. 验证数据已入库
curl "${WORKER_URL}/latest"
# 应该返回: 2025133
```

### 场景3：模拟新数据入库

**方法**：删除数据库中最新的一条记录，然后测试

```bash
# 1. 查看当前最新记录
curl "${WORKER_URL}/latest"
# 假设返回: 2025132

# 2. 删除最新记录（需要数据库操作权限）
# 方法A: 使用 wrangler d1 execute
wrangler d1 execute lottery-db --command="DELETE FROM ssq WHERE lottery_no = '2025132'"

# 方法B: 使用 SQL 客户端连接数据库删除

# 3. 验证删除成功
curl "${WORKER_URL}/latest"
# 应该返回: 2025131

# 4. 执行增量爬取
curl -X POST \
  -H "Authorization: Bearer ${API_KEY}" \
  "${WORKER_URL}/run"

# 预期响应：
# {
#   "success": true,
#   "message": "增量更新完成",
#   "mode": "incremental",
#   "new_count": 1,
#   "lottery_no": "2025132",
#   "draw_date": "2025-XX-XX"
# }

# 5. 验证数据已恢复
curl "${WORKER_URL}/latest"
# 应该返回: 2025132
```

### 场景4：数据源失败（测试降级逻辑）

**方法**：观察日志，看是否正确降级到中彩网

```bash
# 执行增量爬取
curl -X POST \
  -H "Authorization: Bearer ${API_KEY}" \
  "${WORKER_URL}/run"

# 查看 Cloudflare Workers 日志
wrangler tail

# 预期日志：
# 从 500.com 获取最新一期数据...
# 从 500.com 获取最新数据失败: HTTP 500
# 降级到中彩网获取最新数据...
# 线上最新记录（中彩网）: 2025XXX (2025-XX-XX)
```

## 验证要点

### ✅ 正确行为

1. **数据已是最新时**
   - 返回 `success: true`
   - 返回 `message: "数据已是最新"` 或 `"数据已存在"`
   - 不会重复入库

2. **有新数据时**
   - 返回 `success: true`
   - 返回 `message: "增量更新完成"`
   - 返回 `new_count: 1`
   - 数据成功入库
   - 发送 Telegram 通知

3. **数据源失败时**
   - 自动降级到中彩网
   - 如果都失败，返回详细错误信息

### ❌ 错误行为

1. **重复入库**
   - 同一期号被插入多次
   - 检查：`curl "${WORKER_URL}/stats"` 查看总数是否异常增长

2. **无限循环**
   - 请求一直不返回
   - 检查：设置超时 `curl --max-time 30`

3. **期号格式错误**
   - 期号不是7位（如 `25132` 而不是 `2025132`）
   - 检查：`curl "${WORKER_URL}/latest"` 查看期号格式

## 日志检查

```bash
# 实时查看 Worker 日志
wrangler tail

# 关键日志信息：
# ✅ 从 500.com 获取最新一期数据...
# ✅ 线上最新记录: 2025XXX (2025-XX-XX)
# ✅ 数据已是最新，无需更新
# 或
# ✅ 准备入库新数据: 2025XXX (2025-XX-XX)
# ✅ 入库完成: 新增 1 条
```

## 定时任务测试

```bash
# 1. 配置 Cloudflare Cron Trigger（在 Dashboard 中）
# 触发器: 0 22 * * 2,4,0  # 每周二、四、日 22:00

# 2. 手动触发测试
wrangler publish
wrangler tail  # 在另一个终端查看日志

# 3. 等待定时任务执行，或手动触发
curl -X POST \
  -H "Authorization: Bearer ${API_KEY}" \
  "${WORKER_URL}/run"
```

## 常见问题

### Q1: 返回"数据已是最新"，但实际有新一期开奖了？

**排查步骤**：
1. 检查 500.com 是否已更新：访问 https://datachart.500.com/ssq/history/history.shtml
2. 检查数据库最新记录：`curl "${WORKER_URL}/latest"`
3. 查看 Worker 日志：`wrangler tail`

### Q2: 期号格式不对（5位而不是7位）？

**原因**：`parse500Html` 方法没有正确补全期号

**检查**：
```bash
# 查看最新记录的期号格式
curl "${WORKER_URL}/latest" | jq '.lottery_no'
# 应该是 "2025132" 而不是 "25132"
```

### Q3: 增量爬取一直失败？

**排查步骤**：
1. 测试 500.com 可访问性：`curl -I https://datachart.500.com/ssq/history/history.shtml`
2. 测试中彩网可访问性：`curl -I https://jc.zhcw.com/port/client_json.php`
3. 查看详细错误日志：`wrangler tail`
