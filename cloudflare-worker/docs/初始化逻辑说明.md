# 初始化逻辑说明

## 问题

之前的逻辑有缺陷：
- ❌ 只要数据库中有数据（> 0），就进入增量更新模式
- ❌ 不会继续爬取历史数据
- ❌ 导致只有最近几十期的数据

## 修复后的逻辑

### 判断标准

```javascript
const FULL_DATA_THRESHOLD = 1000; // 数据完整的阈值
const isInitializing = dataCount < FULL_DATA_THRESHOLD;
```

- **初始化阶段**：数据量 < 1000 期
- **增量更新阶段**：数据量 >= 1000 期

### 工作流程

#### 阶段 1：初始化（数据量 < 1000）

```
数据库: 0 条
  ↓
爬取 100 期 → 保存 → 数据库: 100 条
  ↓
继续触发 /run
  ↓
爬取 100 期 → 保存 → 数据库: 200 条
  ↓
... 重复 ...
  ↓
数据库: 1000 条 → 进入增量更新阶段
```

#### 阶段 2：增量更新（数据量 >= 1000）

```
数据库: 1000+ 条
  ↓
检查最新期号
  ↓
如果有新数据 → 爬取并保存
如果没有新数据 → 返回"数据已是最新"
```

## 为什么选择 1000 作为阈值？

1. **双色球历史数据**：
   - 从 2003 年开始
   - 每周 3 次
   - 累计约 4000+ 期

2. **1000 期的意义**：
   - 约 6-7 个月的数据
   - 足够进行基本的统计分析
   - 可以作为"数据基本完整"的标志

3. **灵活性**：
   - 可以根据需要调整阈值
   - 如果想要更多历史数据，可以设置为 2000 或 3000

## 使用方式

### 首次初始化

```bash
# 1. 清空数据库（如果需要）
# 在 Cloudflare Dashboard 的 D1 Console 中执行：
# DELETE FROM ssq_lottery;

# 2. 运行初始化脚本
bash cloudflare-worker/init.sh

# 3. 脚本会自动：
#    - 检测数据量
#    - 如果 < 1000，继续爬取
#    - 如果 >= 1000，进入增量模式
```

### 查看进度

```bash
export http_proxy="http://127.0.0.1:7897"
export https_proxy="http://127.0.0.1:7897"
curl -s "https://lottery-prediction.githubmen.workers.dev/stats" | jq '.total_count'
```

### 手动触发

```bash
export http_proxy="http://127.0.0.1:7897"
export https_proxy="http://127.0.0.1:7897"
curl -X POST "https://lottery-prediction.githubmen.workers.dev/run" \
  -H "Authorization: Bearer YOUR_API_KEY" | jq '.'
```

## 响应示例

### 初始化阶段

```json
{
  "success": true,
  "message": "初始化中（200/1000）",
  "mode": "full",
  "inserted": 100,
  "skipped": 0,
  "total": 200,
  "progress": 20,
  "batch_size": 100
}
```

### 增量更新阶段

```json
{
  "success": true,
  "message": "数据已是最新",
  "mode": "incremental",
  "lottery_no": "2025132"
}
```

或

```json
{
  "success": true,
  "message": "增量更新完成",
  "mode": "incremental",
  "new_count": 3,
  "latest_lottery_no": "2025135"
}
```

## 调整阈值

如果你想要更多或更少的历史数据，可以修改 `src/index.js` 中的阈值：

```javascript
// 修改这个值
const FULL_DATA_THRESHOLD = 1000; // 改为 2000、3000 等
```

然后重新部署：

```bash
cd cloudflare-worker
npx wrangler deploy
```

## 预计时间

- **每批次**：100 期，约 1-2 分钟
- **达到 1000 期**：约 10 批次，20-30 分钟
- **达到 4000 期**：约 40 批次，80-120 分钟

## 注意事项

1. **Cloudflare Worker 限制**：
   - CPU 时间：约 30 秒
   - 每批次不能太大，否则会超时

2. **数据源限制**：
   - 中彩网 API：单次最多 1000 期
   - 500.com：只返回最近 30 期

3. **建议**：
   - 使用自动化脚本（`init.sh`）
   - 让它自动运行，直到完成
   - 或者手动触发多次

---

**修复完成时间**：2025-11-17  
**修复内容**：添加数据完整性判断，支持持续爬取直到数据完整
