# 快速修复指南

## 问题诊断

运行诊断脚本发现：**Worker 无法访问**

```bash
❌ Worker 无法访问（连接失败）
HTTP Status: 000
连接超时: 75 秒
```

## 可能的原因

1. ❌ Worker 未部署或部署失败
2. ❌ Worker URL 不正确
3. ❌ Worker 被删除或暂停
4. ❌ 网络问题

## 解决方案

### 步骤 1: 检查 Worker 状态

1. 登录 Cloudflare Dashboard: https://dash.cloudflare.com
2. 进入 **Workers & Pages**
3. 查找你的 Worker：`lottery-prediction`
4. 检查状态是否为 **Active**

### 步骤 2: 验证 Worker URL

在浏览器中访问：
```
https://lottery-prediction.githubmen.workers.dev
```

**预期结果**：
```
🎰 彩票预测系统 - Cloudflare Workers 版本

可用接口:
  POST /run - 手动执行每日任务
  ...
```

**如果无法访问**：
- Worker 未部署或 URL 不正确
- 需要重新部署

### 步骤 3: 重新部署 Worker

#### 方式 1: 本地部署（推荐）

```bash
# 1. 进入目录
cd cloudflare-worker

# 2. 登录 Cloudflare
npx wrangler login

# 3. 检查配置
cat wrangler.toml

# 4. 部署
npx wrangler deploy

# 5. 查看部署结果
# 会显示 Worker URL，例如：
# Published lottery-prediction (1.23 sec)
#   https://lottery-prediction.githubmen.workers.dev
```

#### 方式 2: 通过 GitHub Pages 部署

1. 确保代码已推送到 GitHub
2. 在 Cloudflare Dashboard 中：
   - Workers & Pages > Create application
   - Pages > Connect to Git
   - 选择你的仓库
   - 配置构建设置（留空）
   - 部署

### 步骤 4: 配置绑定

部署后，需要配置 D1 和 KV 绑定：

1. 进入 Worker 设置
2. **Settings > Variables**
3. 添加绑定：
   - **D1 Database Bindings**:
     - Variable name: `DB`
     - D1 database: 选择你的数据库
   - **KV Namespace Bindings**:
     - Variable name: `KV_BINDING`
     - KV namespace: 选择你的命名空间

### 步骤 5: 验证部署

```bash
# 运行诊断脚本
bash cloudflare-worker/diagnose.sh

# 预期结果：
# ✅ Worker 可访问
# ✅ /latest 接口正常
# ✅ /stats 接口正常
```

### 步骤 6: 初始化数据

```bash
# 方式 1: 使用自动化脚本
./cloudflare-worker/init.sh

# 方式 2: 手动触发
curl -X POST https://lottery-prediction.githubmen.workers.dev/run \
  -H "Authorization: Bearer YOUR_API_KEY"
```

## 常见问题

### Q1: wrangler 命令找不到

```bash
# 安装 wrangler
npm install -g wrangler

# 或使用 npx
npx wrangler login
```

### Q2: 部署时提示 "database_id" 为空

编辑 `wrangler.toml`，填入你的 database_id：

```toml
[[d1_databases]]
binding = "DB"
database_name = "lottery_db"
database_id = "你的database_id"  # 在 Cloudflare Dashboard 中查看
```

### Q3: 部署成功但接口返回 500

检查：
1. D1 数据库是否已创建
2. KV 命名空间是否已创建
3. 绑定是否正确配置
4. 查看 Worker 日志（Dashboard > Workers > Logs）

### Q4: API_KEY 认证失败

1. 检查 KV 中的 `API_KEY` 值
2. 确保脚本中的 API_KEY 与 KV 中一致
3. 注意：API_KEY 区分大小写

## 快速检查清单

- [ ] Worker 已部署
- [ ] Worker URL 可访问
- [ ] D1 数据库已创建并绑定
- [ ] KV 命名空间已创建并绑定
- [ ] KV 中已配置 API_KEY、TELEGRAM_BOT_TOKEN、TELEGRAM_CHAT_ID
- [ ] 数据库表结构已创建（运行 schema.sql）
- [ ] 诊断脚本显示全部正常

## 获取帮助

如果以上步骤都无法解决问题：

1. **查看 Worker 日志**：
   - Cloudflare Dashboard > Workers > 你的 Worker > Logs
   - 查看实时日志和错误信息

2. **检查网络**：
   ```bash
   # 测试网络连接
   curl -v https://lottery-prediction.githubmen.workers.dev
   ```

3. **重新创建 Worker**：
   - 删除现有 Worker
   - 重新部署
   - 重新配置绑定

4. **使用 Python 版本**：
   - 如果 Cloudflare Worker 持续有问题
   - 可以先使用 Python 版本在本地运行
   - Python 版本已经修复并测试通过

---

**提示**：确保你的 Cloudflare 账号已经验证邮箱，否则可能无法部署 Worker。
