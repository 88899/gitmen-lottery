# æ¥å£å¯¹æ¯”ï¼šPython vs Cloudflare Worker

## ğŸ¯ è®¾è®¡ç†å¿µ

ä¸¤ä¸ªç‰ˆæœ¬ç°åœ¨å®Œå…¨ä¸€è‡´ï¼š**åˆå§‹åŒ–å’Œå¢é‡æ›´æ–°é€»è¾‘å®Œå…¨åˆ†ç¦»**

## ğŸ“Š æ¥å£å¯¹æ¯”

| åŠŸèƒ½ | Cloudflare Worker | Python |
|------|------------------|--------|
| æ‰¹é‡åˆå§‹åŒ– | `/init` | `fetch_batch_init()` |
| å¢é‡æ›´æ–° | `/run` | `fetch_incremental()` |
| è·å–æœ€æ–° | `/latest` | `fetch_latest()` |
| ç»Ÿè®¡ä¿¡æ¯ | `/stats` | `db.get_count()` |

## ğŸ”„ æ‰¹é‡åˆå§‹åŒ–å¯¹æ¯”

### Cloudflare Worker

```javascript
// POST /init
// æ¯æ¬¡çˆ¬å– 100 æœŸï¼Œè‡ªåŠ¨å»é‡

const batchSize = 100;
const allData = await spider.fetchAll(batchSize);
const result = await db.batchInsert('ssq', allData);

// è¿”å›
{
  "inserted": 95,
  "skipped": 5,
  "total": 200
}
```

### Python

```python
# fetch_batch_init(batch_size=100)
# æ¯æ¬¡çˆ¬å– 100 æœŸï¼Œè‡ªåŠ¨å»é‡

batch_size = 100
data = spider.fetch_batch_init(batch_size=batch_size)

# ä¿å­˜åˆ°æ•°æ®åº“ï¼ˆè‡ªåŠ¨å»é‡ï¼‰
for item in data:
    try:
        db.insert(item)
    except DuplicateError:
        pass  # è·³è¿‡é‡å¤æ•°æ®
```

**ç‰¹ç‚¹**ï¼š
- âœ… å›ºå®šæ‰¹æ¬¡å¤§å°
- âœ… ä¸å…³å¿ƒæ•°æ®åº“çŠ¶æ€
- âœ… å¯é‡å¤æ‰§è¡Œ
- âœ… è‡ªåŠ¨å»é‡

## ğŸ”„ å¢é‡æ›´æ–°å¯¹æ¯”

### Cloudflare Worker

```javascript
// POST /run
// ä»æ•°æ®åº“æœ€æ–°å¾€åçˆ¬

const dbLatest = await db.getLatest('ssq');
const onlineLatest = await spider.fetchLatest();

// ä» dbLatest + 1 çˆ¬åˆ° onlineLatest
for (let issue = dbLatest + 1; issue <= onlineLatest; issue++) {
  if (!exists(issue)) {
    fetch(issue);
  }
}

// è¿”å›
{
  "new_count": 5,
  "latest_lottery_no": "2025135"
}
```

### Python

```python
# fetch_incremental(db_latest_no)
# ä»æ•°æ®åº“æœ€æ–°å¾€åçˆ¬

db_latest_no = db.get_latest()['lottery_no']
new_data = spider.fetch_incremental(db_latest_no)

# ä» db_latest_no + 1 çˆ¬åˆ° online_latest
# è‡ªåŠ¨æ£€æŸ¥ï¼Œä¸å­˜åœ¨å°±çˆ¬å–

# è¿”å›
# [
#   {'lottery_no': '2025131', ...},
#   {'lottery_no': '2025132', ...},
#   ...
# ]
```

**ç‰¹ç‚¹**ï¼š
- âœ… ä»æ•°æ®åº“æœ€æ–°å¾€åçˆ¬
- âœ… æ™ºèƒ½æ£€æµ‹ç¼ºå¤±æ•°æ®
- âœ… ä¸ä¼šæ¼æ•°æ®
- âœ… è‡ªåŠ¨è¡¥å…¨

## ğŸ“ ä½¿ç”¨åœºæ™¯å¯¹æ¯”

### åœºæ™¯ 1ï¼šé¦–æ¬¡åˆå§‹åŒ–

**Cloudflare Worker**ï¼š
```bash
# ä½¿ç”¨è„šæœ¬
bash cloudflare-worker/scripts/init.sh

# æˆ–æ‰‹åŠ¨è§¦å‘
curl -X POST "https://your-worker.workers.dev/init" \
  -H "Authorization: Bearer YOUR_API_KEY"
```

**Python**ï¼š
```bash
# ä½¿ç”¨è„šæœ¬
python scripts/init_ssq.py

# æˆ–æ‰‹åŠ¨è°ƒç”¨
python -c "
from lotteries.ssq.spider import SSQSpider
spider = SSQSpider()
data = spider.fetch_batch_init(batch_size=100)
"
```

### åœºæ™¯ 2ï¼šæ—¥å¸¸æ›´æ–°

**Cloudflare Worker**ï¼š
```bash
# é…ç½® Cron Triggerï¼ˆè‡ªåŠ¨ï¼‰
# æˆ–æ‰‹åŠ¨è§¦å‘
curl -X POST "https://your-worker.workers.dev/run" \
  -H "Authorization: Bearer YOUR_API_KEY"
```

**Python**ï¼š
```bash
# ä½¿ç”¨è„šæœ¬
python scripts/update_ssq.py

# æˆ–é…ç½® crontab
0 22 * * * python /path/to/scripts/update_ssq.py
```

### åœºæ™¯ 3ï¼šæŸ¥è¯¢æœ€æ–°

**Cloudflare Worker**ï¼š
```bash
curl "https://your-worker.workers.dev/latest"
```

**Python**ï¼š
```python
from lotteries.ssq.spider import SSQSpider
spider = SSQSpider()
latest = spider.fetch_latest(count=1)
```

## ğŸ¯ æ ¸å¿ƒä¼˜åŠ¿

### 1. é€»è¾‘ä¸€è‡´

| ç‰¹æ€§ | Worker | Python |
|------|--------|--------|
| åˆå§‹åŒ–é€»è¾‘ | âœ… ç‹¬ç«‹ | âœ… ç‹¬ç«‹ |
| å¢é‡é€»è¾‘ | âœ… ç‹¬ç«‹ | âœ… ç‹¬ç«‹ |
| åŒæ•°æ®æº | âœ… æ”¯æŒ | âœ… æ”¯æŒ |
| è‡ªåŠ¨åˆ‡æ¢ | âœ… æ”¯æŒ | âœ… æ”¯æŒ |

### 2. æ˜“äºç†è§£

```
åˆå§‹åŒ– â†’ ç”¨æ‰¹é‡æ¥å£
æ›´æ–° â†’ ç”¨å¢é‡æ¥å£
æŸ¥è¯¢ â†’ ç”¨æŸ¥è¯¢æ¥å£
```

### 3. å¯é‡å¤æ‰§è¡Œ

```
åˆå§‹åŒ–ï¼šå¯ä»¥å¤šæ¬¡æ‰§è¡Œï¼Œè‡ªåŠ¨å»é‡
æ›´æ–°ï¼šå¯ä»¥å¤šæ¬¡æ‰§è¡Œï¼Œè‡ªåŠ¨è¡¥å…¨
æŸ¥è¯¢ï¼šéšæ—¶å¯ä»¥æŸ¥è¯¢
```

### 4. å®¹é”™æ€§å¥½

```
æŸä¸€æœŸå¤±è´¥ â†’ ä¸å½±å“å…¶ä»–æœŸ
æ•°æ®æºå¤±è´¥ â†’ è‡ªåŠ¨åˆ‡æ¢
ç½‘ç»œè¶…æ—¶ â†’ å¯ä»¥é‡è¯•
```

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | Cloudflare Worker | Python |
|------|------------------|--------|
| æ‰¹æ¬¡å¤§å° | 100 æœŸ | 100 æœŸ |
| å•æ‰¹è€—æ—¶ | 1-2 åˆ†é’Ÿ | 1-2 åˆ†é’Ÿ |
| å¹¶å‘æ”¯æŒ | âœ… è‡ªåŠ¨æ‰©å±• | âŒ å•çº¿ç¨‹ |
| æˆæœ¬ | å…è´¹ | æœåŠ¡å™¨æˆæœ¬ |
| éƒ¨ç½² | ç®€å• | éœ€è¦æœåŠ¡å™¨ |

## ğŸ”§ æŠ€æœ¯å®ç°å¯¹æ¯”

### æ•°æ®æºåˆ‡æ¢

**Cloudflare Worker**ï¼š
```javascript
try {
  return await fetchFromZhcw();
} catch (error) {
  return await fetchFrom500();
}
```

**Python**ï¼š
```python
try:
    return self.fetch_api_recent()
except Exception:
    return self.fetch_latest_from_500com()
```

### å¢é‡æ›´æ–°

**Cloudflare Worker**ï¼š
```javascript
for (let issue = dbLatest + 1; issue <= onlineLatest; issue++) {
  const exists = await db.checkExists('ssq', issue);
  if (!exists) {
    const data = await spider.fetchIssueDetail(issue);
    newDataList.push(data);
  }
}
```

**Python**ï¼š
```python
for issue_num in range(db_issue_num + 1, online_issue_num + 1):
    current_issue = str(issue_num).zfill(len(db_latest_no))
    issue_data = self.fetch_api_issue(current_issue)
    if issue_data:
        new_data_list.append(issue_data)
```

### è‡ªåŠ¨å»é‡

**Cloudflare Worker**ï¼š
```sql
-- D1 æ•°æ®åº“
CREATE TABLE ssq_lottery (
  lottery_no TEXT UNIQUE NOT NULL
);
```

**Python**ï¼š
```sql
-- MySQL æ•°æ®åº“
CREATE TABLE ssq_lottery (
  lottery_no VARCHAR(20) UNIQUE NOT NULL
);
```

## ğŸ“š æ–‡æ¡£å¯¹æ¯”

| æ–‡æ¡£ | Cloudflare Worker | Python |
|------|------------------|--------|
| å¿«é€Ÿå¼€å§‹ | `cloudflare-worker/docs/å¿«é€Ÿå¼€å§‹.md` | `lotteries/ssq/ä½¿ç”¨æŒ‡å—.md` |
| æ¥å£è®¾è®¡ | `cloudflare-worker/docs/æ¥å£è®¾è®¡è¯´æ˜.md` | `lotteries/ssq/ä½¿ç”¨æŒ‡å—.md` |
| ä¿®å¤è¯´æ˜ | `cloudflare-worker/docs/å¢é‡æ›´æ–°é€»è¾‘ä¿®å¤.md` | `lotteries/ssq/BUGFIX_README.md` |

## âœ… æ€»ç»“

ä¸¤ä¸ªç‰ˆæœ¬ç°åœ¨å®Œå…¨ä¸€è‡´ï¼š

1. **âœ… é€»è¾‘åˆ†ç¦»**ï¼šåˆå§‹åŒ–å’Œå¢é‡æ›´æ–°å®Œå…¨ç‹¬ç«‹
2. **âœ… åŒæ•°æ®æº**ï¼šéƒ½æ”¯æŒè‡ªåŠ¨åˆ‡æ¢
3. **âœ… ä¸æ¼æ•°æ®**ï¼šå¢é‡æ›´æ–°ä»æ•°æ®åº“æœ€æ–°å¾€åçˆ¬
4. **âœ… å¯é‡å¤æ‰§è¡Œ**ï¼šè‡ªåŠ¨å»é‡ï¼Œå®‰å…¨å¯é 

é€‰æ‹©å“ªä¸ªç‰ˆæœ¬å–å†³äºä½ çš„éœ€æ±‚ï¼š
- **Cloudflare Worker**ï¼šå…è´¹ã€è‡ªåŠ¨æ‰©å±•ã€å…¨çƒ CDN
- **Python**ï¼šåŠŸèƒ½ä¸°å¯Œã€æ˜“äºæ‰©å±•ã€æœ¬åœ°è¿è¡Œ

---

**æœ€åæ›´æ–°**ï¼š2025-11-17  
**ç‰ˆæœ¬**ï¼š2.0.0
